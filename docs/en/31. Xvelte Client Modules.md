# 31. Xvelte Client Modules

Xvelte applications use several modules on the client side to dynamically create pages and manage interactions. These modules are responsible for client-side navigation, state management, partial hydration (islands), and more. They can be accessed via the `@hotsixman/xvelte/client` path.

## Key Modules and Features

### 1. Navigation (`navigation`)

Client-side navigation is one of Xvelte's core features. When a user navigates to a different page, it dynamically replaces only the necessary parts without a full page reload.

- **`goto(url, options)`**: A function used to programmatically navigate to another page.
  - `url`: The path to navigate to (string or URL object).
  - `options.type`: Specifies how to handle the browser history, either `'push'` (default) or `'replace'`.
  - `options.state`: A custom state object to save in `history.state`.

**`goto` Usage Example:**
```svelte
<script>
    import { goto } from '@hotsixman/xvelte/client';

    function goToAboutPage() {
        // Navigates to the '/about' page.
        goto('/about');
    }

    function updateUser() {
        // Updates history.state without navigating.
        goto(location.href, {
            type: 'replace',
            state: { user: { name: 'John', id: 1 } }
        });
    }
</script>

<button on:click={goToAboutPage}>Go to About Page</button>
<button on:click={updateUser}>Update User Info</button>
```

- **Automatic Link Handling**: By default, Xvelte intercepts click events on all `<a>` tags and calls the `goto` function, so client-side navigation works without any extra setup.

- **History Management**: It internally manages the browser's `history.pushState` and `history.replaceState`. It is recommended to use the `pushState`, `replaceState`, or `goto` functions provided by Xvelte instead of directly manipulating the `history` object.

### 2. Stores (`stores`)

Xvelte manages application state through Svelte stores and provides several built-in stores for use on the client.

- **`page`**: A writable store containing information about the current page.
  - `url`: The `URL` object of the current page.
  - `state`: The custom state object stored in `history.state`.

- **`navigating`**: A writable store that is active when a page navigation is in progress.
  - `from`: The origin `URL` object.
  - `to`: The destination `URL` object.
  - The value becomes `null` when the navigation is complete. This is useful for displaying loading indicators during routing.

**Store Usage Example:**
```svelte
<script>
    import { page, navigating } from '@hotsixman/xvelte/client';

    // Subscribe to the navigating store to display a loading state.
    $: isLoading = $navigating !== null;

    // Get the current URL and state from the page store.
    $: currentPath = $page.url.pathname;
    $: user = $page.state.user;
</script>

{#if isLoading}
    <p>Loading page...</p>
{/if}

<p>Current Path: {currentPath}</p>

{#if user}
    <p>User: {user.name}</p>
{/if}
```

### 3. Island and Fragment Management

- **`<svelte:island>` (`islandElement.ts`)**: A custom element that implements islands (partial hydration). This element dynamically loads and mounts the specified Svelte component when the condition specified in the `on` prop (e.g., `visible`, `click`) is met.

- **`fragManager.ts`**: An internal Xvelte module that manages the HTML fragments that make up a page. During page navigation, it determines which fragments to keep and which to replace to efficiently update the DOM.

## Global Object: `window.__xvelte__`

When the Xvelte client module is initialized, a global object named `window.__xvelte__` is created. This object contains the core functions of the Xvelte system and can be useful for debugging or implementing advanced interactions.

- **`fragManager`**: The fragment manager instance.
- **`mount`, `unmount`**: Functions to manually mount or unmount Svelte components.
- **`context`**: A `Map` object for storing global context.
- **`navigating`, `page`**: The store objects described above.
- **`history`**: Provides access to the `history`-related functions controlled by Xvelte (`pushState`, `replaceState`) and the original `history` functions (`original`).

**`history.pushState` Usage Example:**
```javascript
// This code can be used in a regular JavaScript file outside of a Svelte component.
import { history } from '@hotsixman/xvelte/client';

function updateStateWithoutNavigation() {
    history.pushState({ modalOpen: true }, '/home');
}
```

These client modules are the foundation of the user experience in Xvelte. Developers can use these modules to implement complex client-side logic.
