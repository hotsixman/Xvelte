# 31. Xvelte Client Modules

Xvelte applications use several modules on the client side to dynamically create pages and manage interactions. These modules are responsible for client-side navigation, state management, partial hydration (islands), etc., and can be accessed via the `@hotsixman/xvelte/client` path.

## Main Modules and Features

### 1. Navigation (`navigation`)

Client-side navigation is one of the main features of Xvelte. When a user navigates between pages, it provides an improved user experience by dynamically replacing only the necessary parts without a full page reload.

- **`goto(url, options)`**: A function used to programmatically navigate to another page.
  - `url`: The path to navigate to (a string or URL object).
  - `options.type`: Determines how to handle the browser history, either `'push'` (default) or `'replace'`.
  - `options.state`: A custom state object to be saved in `history.state`.

**`goto` Usage Example:**
```svelte
<script>
    import { goto } from '@hotsixman/xvelte/client';

    function goToAboutPage() {
        // Navigates to the '/about' page.
        goto('/about');
    }
</script>

<button on:click={goToAboutPage}>Go to About Page</button>
```

- **Automatic Link Handling**: By default, Xvelte is set up to intercept click events on all `<a>` tags and call the `goto` function, enabling client-side navigation without any extra setup.

  Sometimes you may want to disable this feature. For example, you might want to force a full page reload when a specific link is clicked. In this case, you can add the `xvelte-disable-spa` attribute to the `<a>` tag.

  **Disabling SPA Navigation Example:**
  ```svelte
  <!-- This link will not use SPA navigation and will perform a full page reload. -->
  <a href="/admin" xvelte-disable-spa>Admin Page (Reload)</a>
  ```

- **History Management**: It internally manages the browser's `history.pushState` and `history.replaceState`. Instead of directly manipulating the `history` object, it is recommended to use the `pushState`, `replaceState`, or `goto` functions provided by Xvelte.

### 2. Stores (`stores`)

Xvelte manages the application's state through Svelte stores and provides several built-in stores for use on the client.

- **`page`**: A store containing information about the current page.
  - `url`: The `URL` object of the current page.
  - `state`: The custom state object stored in `history.state`.

- **`navigating`**: A store that becomes active when a page navigation is in progress.
  - `from`: The origin `URL` object.
  - `to`: The destination `URL` object.
  - The value becomes `null` when the navigation is complete. This is useful for displaying loading indicators during routing.

**Store Usage Example:**
```svelte
<script>
    import { page, navigating } from '@hotsixman/xvelte/client';

    // Subscribe to the navigating store to display a loading state.
    $: isLoading = $navigating !== null;

    // Get the current URL from the page store.
    $: currentPath = $page.url.pathname;
</script>

{#if isLoading}
    <p>Loading page...</p>
{/if}

<p>Current path: {currentPath}</p>
```

### 3. Island and Fragment Management

- **`<Island>` (`islandElement.ts`)**: A custom element that implements islands (partial hydration). This element dynamically loads and mounts a specified Svelte component when the condition specified in the `on` prop (e.g., `visible`, `click`) is met.

- **`fragManager.ts`**: An internal Xvelte module that manages the HTML fragments that make up a page. When navigating, it determines which fragments to keep and which to replace to efficiently update the DOM.

## Global Object: `window.__xvelte__`

When the Xvelte client modules are initialized, a global object named `window.__xvelte__` is created. This object contains the core functions of the Xvelte system and can be useful for debugging or implementing advanced interactions.

- **`fragManager`**: The fragment manager instance.
- **`mount`, `unmount`**: Functions to manually mount or unmount Svelte components.
- **`context`**: A `Map` object for storing global context.
- **`navigating`, `page`**: The store objects described above.
- **`history`**: Provides access to Xvelte-controlled `history` functions (`pushState`, `replaceState`) and the original `history` functions (`original`).

**`history.pushState` Usage Example:**
```javascript
// This code can be used in a regular JavaScript file outside of a Svelte component.
import { history } from '@hotsixman/xvelte/client';

function updateStateWithoutNavigation() {
    history.pushState({ modalOpen: true }, '/home');
}
```

These client modules form the basis of the Xvelte user experience. Developers can use these modules to implement complex client-side logic.