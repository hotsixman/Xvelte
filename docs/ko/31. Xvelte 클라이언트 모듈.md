# 31. Xvelte 클라이언트 모듈

Xvelte 애플리케이션은 클라이언트 측에서 페이지를 동적으로 만들고 상호작용을 관리하기 위해 여러 모듈을 사용합니다. 이 모듈들은 클라이언트 사이드 네비게이션, 상태 관리, 부분 하이드레이션(아일랜드) 등을 담당하며, `@hotsixman/xvelte/client` 경로를 통해 접근할 수 있습니다.

## 주요 모듈 및 기능

### 1. 네비게이션 (`navigation`)

클라이언트 사이드 네비게이션은 Xvelte의 주요 기능 중 하나입니다. 사용자가 페이지를 이동할 때 전체 페이지를 새로고침하지 않고 필요한 부분만 동적으로 교체하여 향상된 사용자 경험을 제공합니다.

- **`goto(url, options)`**: 프로그래매틱하게 다른 페이지로 이동할 때 사용하는 함수입니다.
  - `url`: 이동할 경로 (문자열 또는 URL 객체).
  - `options.type`: `'push'` (기본값) 또는 `'replace'`를 지정하여 브라우저 히스토리를 어떻게 처리할지 결정합니다.
  - `options.state`: `history.state`에 저장할 사용자 정의 상태 객체입니다.

**`goto` 사용 예시:**
```svelte
<script>
    import { goto } from '@hotsixman/xvelte/client';

    function goToAboutPage() {
        // '/about' 페이지로 이동합니다.
        goto('/about');
    }
</script>

<button on:click={goToAboutPage}>소개 페이지로 가기</button>
```

- **자동 링크 처리**: Xvelte는 기본적으로 모든 `<a>` 태그의 클릭 이벤트를 가로채 `goto` 함수를 호출하도록 설정하여, 별도의 설정 없이도 클라이언트 사이드 네비게이션이 동작합니다.

  때로는 이 기능을 비활성화하고 싶을 수 있습니다. 예를 들어, 특정 링크를 클릭했을 때 항상 전체 페이지를 새로고침하도록 강제하고 싶을 때가 있습니다. 이 경우 `<a>` 태그에 `xvelte-disable-spa` 속성을 추가하면 됩니다.

  **SPA 네비게이션 비활성화 예시:**
  ```svelte
  <!-- 이 링크는 SPA 네비게이션을 사용하지 않고, 전체 페이지를 새로고침하며 이동합니다. -->
  <a href="/admin" xvelte-disable-spa>관리자 페이지 (새로고침)</a>
  ```

- **히스토리 관리**: 브라우저의 `history.pushState`와 `history.replaceState`를 내부적으로 관리합니다. 직접 `history` 객체를 조작하는 대신, Xvelte가 제공하는 `pushState`, `replaceState` 함수나 `goto` 함수를 사용하는 것이 권장됩니다.

### 2. 스토어 (`stores`)

Xvelte는 Svelte 스토어를 통해 애플리케이션의 상태를 관리하며, 클라이언트에서 사용할 수 있는 몇 가지 내장 스토어를 제공합니다.

- **`page`**: 현재 페이지에 대한 정보를 담고 있는 스토어입니다.
  - `url`: 현재 페이지의 `URL` 객체.
  - `state`: `history.state`에 저장된 사용자 정의 상태 객체.

- **`navigating`**: 페이지 이동이 진행 중일 때 활성화되는 스토어입니다.
  - `from`: 출발지 `URL` 객체.
  - `to`: 목적지 `URL` 객체.
  - 페이지 이동이 끝나면 값은 `null`이 됩니다. 라우팅 과정에서 로딩 인디케이터 등을 표시하는 데 유용합니다.

**스토어 사용 예시:**
```svelte
<script>
    import { page, navigating } from '@hotsixman/xvelte/client';

    // navigating 스토어를 구독하여 로딩 상태를 표시합니다.
    $: isLoading = $navigating !== null;

    // page 스토어에서 현재 URL과 상태를 가져옵니다.
    $: currentPath = $page.url.pathname;
</script>

{#if isLoading}
    <p>페이지를 불러오는 중...</p>
{/if}

<p>현재 경로: {currentPath}</p>
```

### 3. 아일랜드 및 프래그먼트 관리

- **`<Island>` (`islandElement.ts`)**: 아일랜드(부분 하이드레이션)를 구현하는 커스텀 엘리먼트입니다. 이 엘리먼트는 `on` prop (`visible`, `click` 등)에 지정된 조건이 충족되면 지정된 Svelte 컴포넌트를 동적으로 로드하고 마운트합니다.

- **`fragManager.ts`**: Xvelte의 내부 모듈로, 페이지를 구성하는 HTML 조각(프래그먼트)을 관리합니다. 페이지 이동 시 어떤 프래그먼트를 유지하고 어떤 것을 교체할지 결정하여 DOM을 효율적으로 업데이트합니다.

## 전역 객체: `window.__xvelte__`

Xvelte 클라이언트 모듈이 초기화되면 `window.__xvelte__`라는 전역 객체가 생성됩니다. 이 객체는 Xvelte 시스템의 핵심 기능들을 담고 있으며, 디버깅이나 고급 상호작용 구현에 유용할 수 있습니다.

- **`fragManager`**: 프래그먼트 매니저 인스턴스.
- **`mount`, `unmount`**: Svelte 컴포넌트를 수동으로 마운트하거나 언마운트하는 함수.
- **`context`**: 전역 컨텍스트를 저장하는 `Map` 객체.
- **`navigating`, `page`**: 위에서 설명한 스토어 객체.
- **`history`**: Xvelte가 제어하는 `history` 관련 함수들 (`pushState`, `replaceState`)과 원본 `history` 함수(`original`)에 접근할 수 있습니다.

**`history.pushState` 사용 예시:**
```javascript
// 이 코드는 Svelte 컴포넌트 외부의 일반 JavaScript 파일에서 사용할 수 있습니다.
import { history } from '@hotsixman/xvelte/client';

function updateStateWithoutNavigation() {
    history.pushState({ modalOpen: true }, '/home');
}
```

이러한 클라이언트 모듈들은 Xvelte의 사용자 경험의 기반이 됩니다. 개발자는 이 모듈들을 활용하여 복잡한 클라이언트 사이드 로직을 구현할 수 있습니다.
