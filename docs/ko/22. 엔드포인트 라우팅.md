# 22. 엔드포인트 라우팅

Xvelte는 서버에서 API 엔드포인트를 생성하기 위한 라우팅 시스템을 제공합니다. Express.js와 유사한 방식으로 작동하여 익숙하게 사용할 수 있습니다.

## 핸들러 등록

`XvelteApp` 인스턴스에서 HTTP 메소드에 해당하는 메소드를 사용하여 엔드포인트 핸들러를 등록합니다.

-   `app.get(path, handler)`
-   `app.post(path, handler)`
-   `app.put(path, handler)`
-   `app.delete(path, handler)`
-   `app.all(path, handler)`: 모든 메소드 처리

```ts
// src/app.ts
import XvelteApp from '@hotsixman/xvelte';
import template from './app.html?raw';

const app = new XvelteApp(template);

// GET /api/items
app.get('/api/items', (event) => {
  const items = [{ id: 1, name: 'Xvelte' }];
  
  // Content-Type을 설정하고 JSON 문자열로 변환하여 반환합니다.
  event.setHeader('Content-Type', 'application/json');
  return JSON.stringify(items);
});

// POST /api/items
app.post('/api/items', async (event) => {
  const newItem = await event.json(); // 요청 본문을 JSON으로 파싱
  console.log(newItem);
  event.status = 201; // 응답 상태 코드 설정 (Created)
  
  event.setHeader('Content-Type', 'application/json');
  return JSON.stringify({ success: true, message: 'Item created' });
});
```

## 동적 라우팅

`path-to-regexp` 라이브러리를 사용하여 동적 파라미터를 처리할 수 있습니다. 파라미터는 `event.params` 객체를 통해 접근할 수 있습니다.

```ts
// GET /api/users/:id
app.get('/api/users/:id', (event) => {
  const userId = event.params.id;
  const user = db.findUserById(userId);

  if (user) {
    event.setHeader('Content-Type', 'application/json');
    return JSON.stringify(user);
  } else {
    event.status = 404;
    return 'User not found';
  }
});
```

## `RequestEvent` 객체

모든 핸들러는 `RequestEvent` 객체를 인자로 받으며, 이를 통해 요청을 분석하고 응답을 제어할 수 있습니다. 자세한 내용은 [RequestEvent](./23.%20RequestEvent.md) 문서를 참고하세요.

## 핸들러 반환 값

핸들러는 다양한 타입의 값을 반환하여 클라이언트에 응답할 수 있습니다.

- ArrayBuffer
- Uint8Array
- Blob
- Buffer
- FormData
- ReadStream
- string
- URLSearchParams
- false
- null

여기서 `null`을 반환하면 그냥 핸들러를 종료합니다. 응답을 종료하지 않습니다. 응답을 종료하려면 `event.response.end()` 등을 사용해야합니다.

`false`를 반환하면 응답을 처리하지 않고 다음 핸들러로 넘어갑니다.

**중요:** 일반 객체(`object`)를 반환하면 자동으로 JSON으로 변환되지 않습니다. JSON 응답을 보내려면 반드시 `JSON.stringify()`를 사용하여 문자열로 변환하고, `Content-Type` 헤더를 `application/json`으로 설정해야 합니다.
