# 서버 생성

Xvelte 서버는 다음과 같이 생성할 수 있습니다.
```ts
// src/app.ts
import XvelteApp from '@hotsixman/xvelte';
import template from './app.html?raw';

const app = new XvelteApp(template);

export default app.handler;

if(import.env.meta.PROD){
    app.listen(3000);
}
```

`src/app.ts`는 핸들러를 default로 export해야합니다. 그렇지 않으면 vite의 개발 서버를 사용할 수 없습니다. vercel 등에서 사용할 때도 필요합니다.

## 템플릿

`src/app.html`은 기본적으로 이렇게 작성되어 있습니다.
```html
<html>
    <head>
        <meta charset="utf-8">
        <xvelte-head></xvelte-head>
    </head>
    <body>
        <xvelte-body></xvelte-body>
    </body>
</html>
```

수정할 부분이 있으면 수정해도 괜찮지만, `head` 안의 `xvelte-head`와, `body` 안의 `xvelte-body`는 꼭 필요합니다. SSR 단계에서 이 부분에 각 페이지의 html이 들어갑니다.

## 라우팅
```ts
// src/app.ts
...
// 페이지 라우팅
app.page('/', (event) => {
    const currentTime = new Date().toLocaleTimeString();
    return {
        component: Index,
        props: {
            currentTime
        }
    }
});
// 엔드포인트 라우팅
app.post('/submit', async (event) => {
    const requestBody = await event.json();
    await db.upload(requestBody);

    event.status = 200;
    event.cookie.set('submit', 'true');

    return 'success';
})
...
```
자세한 내용은 [페이지 라우팅](./21.%20페이지%20라우팅.md)과 [엔드포인트 라우팅](./22.%20엔드포인트%20라우팅.md)을 참고하세요.

## 훅 (Hooks)

Xvelte는 요청 처리 파이프라인에 사용자 정의 로직을 삽입할 수 있는 `hook` 기능을 제공합니다. 훅을 사용하면 모든 라우트 핸들러가 실행되기 전에 공통적인 작업을 수행할 수 있습니다. 예를 들어, 인증, 로깅, 또는 요청 객체에 공통 데이터 추가 등의 작업을 처리하기에 유용합니다. 훅은 요청을 받으면 `RequestEvent` 객체를 생성한 직후 바로 실행됩니다.

`app.hook()` 메소드를 사용하여 훅을 등록할 수 있습니다.

```ts
// src/app.ts
app.hook(async (event) => {
  // 모든 요청에 대해 실행됩니다.
  console.log(`[${new Date().toISOString()}] ${event.method.toUpperCase()} ${event.url.pathname}`);

  const session = await getSessionFromCookie(event.cookie.get('sessionId'));
  if (!session && event.url.pathname.startsWith('/admin')) {
    // 관리자 페이지 접근 시 세션이 없으면 로그인 페이지로 리다이렉트
    event.status = 302;
    event.setHeader('Location', '/login');
    return ''; // 응답을 즉시 종료합니다.
  }

  // event.locals에 사용자 정보를 추가하여 다음 핸들러에서 사용할 수 있도록 합니다.
  event.locals.user = session?.user;

  // 다음 훅이나 라우트 핸들러를 계속 실행하려면 event 객체를 반환해야 합니다.
  return event;
});
```

훅 함수는 `RequestEvent` 객체를 인자로 받습니다.

-   훅 함수 내에서 `event` 객체를 수정하여 다음 핸들러에 전달할 수 있습니다.
-   훅 함수가 `event` 객체 대신 다른 값(`string`, `null`, `Buffer` 등)을 반환하면, 해당 값으로 즉시 클라이언트에 응답하고 요청 처리를 종료합니다. 이는 특정 조건에서 요청을 조기에 차단하거나 리다이렉트하는 데 유용합니다.
-   여러 개의 훅을 `XvelteApp.sequence(...hooks)` 함수를 사용하여 순차적으로 실행할 수도 있습니다.
