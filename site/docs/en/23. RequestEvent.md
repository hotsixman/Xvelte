# 23. RequestEvent

The `RequestEvent` object is passed to all route handlers (pages and endpoints) and hooks in Xvelte. It represents the incoming HTTP request and provides all the properties and methods needed to generate and control the response.

## Main Properties

| Property         | Type                   | Description                                                                                             |
| ---------------- | ---------------------- | ------------------------------------------------------------------------------------------------------- |
| `url`            | `URL`                  | A standard `URL` object containing information about the request URL. Used as `url.pathname`, `url.searchParams`, etc. |
| `params`         | `object`               | An object containing URL parameters extracted from dynamic routing. For example, for a request to `/users/123` on the `/users/:id` path, `params` would be `{ id: '123' }`. |
| `requestHeaders` | `object`               | An object containing all the HTTP headers of the request.                                               |
| `locals`         | `object`               | An object for storing and sharing data during the lifecycle of a request. Data saved in `locals` in a hook can be accessed in the route handler. |
| `method`         | `string`               | The HTTP method of the request (e.g., 'get', 'post'). Provided in lowercase.                          |
| `status`         | `number`               | The HTTP status code to be sent in the response. The default is `200` and can be changed within the handler. |
| `cookie`         | `object`               | A utility object for easily handling cookies.                                                           |
| `request`        | `http.IncomingMessage` | The raw Node.js request object. Used when advanced features are needed.                                 |
| `response`       | `http.ServerResponse`  | The raw Node.js response object. Used when advanced features are needed.                                |

## Main Methods

### Request Analysis

-   **`async text(): Promise<string>`**
    Reads the request body as a UTF-8 string and returns it.

-   **`async json(): Promise<any>`**
    Parses the request body as JSON and returns it as a JavaScript object.

-   **`async blob(): Promise<Blob>`**
    Returns the request body as a `Blob` object.

-   **`async buffer(): Promise<Buffer>`**
    Returns the request body as a Node.js `Buffer` object.

-   **`async form(): Promise<{ fields: object, files: object }>`**
    Parses a `multipart/form-data` request body (form data). Returns an object containing text fields and uploaded files.

-   **`getClientAddress(): string`**
    Returns the client's IP address.

### Response Control

-   **`setHeader(key: string, value: string | number | string[]): void`**
    Sets an HTTP header for the response.

-   **`redirect(location: string | URL, status?: number): void`**
    Redirects the client to another page. Calling this method internally sets the `status` code and the `Location` header.
    -   `location`: The path to redirect to.
    -   `status` (Optional): The HTTP status code. The default is `302` (Found). For a permanent move, you can use `301` (Moved Permanently).

-   **`cookie.get(key: string): string | null`**
    Reads the value of a specific cookie from the request.

-   **`cookie.set(key: string, value: string, options: object): void`**
    Sets a cookie for the response. You can specify `path`, `maxAge`, `httpOnly`, etc., through the `options` object.

-   **`cookie.delete(key: string, options: object): void`**
    Sets the response to delete a specific cookie.

## Usage Examples

### Form Data Processing

```ts
// src/routes/api/profile/+server.ts
import type { RequestEvent } from '@hotsixman/xvelte';

export async function post(event: RequestEvent) {
  // Log client IP
  console.log('Client IP:', event.getClientAddress());

  // Parse form data
  const { fields, files } = await event.form();
  const username = fields.username as string;
  const avatar = files.avatar; // { filename, mimeType, buffer }

  // ... file saving and database update logic ...

  // Set response status and headers
  event.status = 201;
  event.setHeader('X-Custom-Header', 'Success');

  // Set a cookie
  event.cookie.set('username', username, { path: '/', httpOnly: true });

  // Return JSON response
  event.setHeader('Content-Type', 'application/json');
  return JSON.stringify({ success: true, username });
}
```

### Redirect

```ts
// src/routes/login/+server.ts
import type { RequestEvent } from '@hotsixman/xvelte';

export function post(event: RequestEvent) {
    // ...login logic...

    // Assuming login is successful, redirect to the main page
    event.redirect('/');

    // You don't need to return anything after calling redirect()
    return null;
}

// src/routes/admin/+server.ts
export function get(event: RequestEvent) {
    const user = event.locals.user; // User info injected from a hook

    // If not an admin, deny access and redirect to the login page
    if (user?.role !== 'admin') {
        event.redirect('/login', 307); // 307: Temporary Redirect
        return null;
    }

    // ...return admin page data...
}
```