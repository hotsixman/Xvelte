# 20. Server Creation

The Xvelte server can be created as follows:
```ts
// src/app.ts
import XvelteApp from '@hotsixman/xvelte';
import template from './app.html?raw';

const app = new XvelteApp(template);

export default app.handler;

if(import.env.meta.PROD){
    app.listen(3000);
}
```

`src/app.ts` must export the handler as the default export. Otherwise, you cannot use Vite's development server. It is also necessary when using services like Vercel.

## Template

`src/app.html` is written like this by default:
```html
<html>
    <head>
        <meta charset="utf-8">
        <xvelte-head></xvelte-head>
    </head>
    <body>
        <xvelte-body></xvelte-body>
    </body>
</html>
```

You can modify it if needed, but `<xvelte-head>` inside the `head` and `<xvelte-body>` inside the `body` are essential. The HTML for each page will be inserted into these sections during the SSR process.

## Routing
```ts
// src/app.ts
...
// Page Routing
app.page('/', (event) => {
    const currentTime = new Date().toLocaleTimeString();
    return {
        component: Index,
        props: {
            currentTime
        }
    }
});
// Endpoint Routing
app.post('/submit', async (event) => {
    const requestBody = await event.json();
    await db.upload(requestBody);

    event.status = 200;
    event.cookie.set('submit', 'true');

    return 'success';
})
...
```

The example above shows the programmatic way of registering routes directly with the `app` instance. Xvelte also supports file-system based routing by creating files in the `src/routes` folder, which is the more recommended approach.

For more details, please refer to [Page Routing](./21. Page Routing.md) and [Endpoint Routing](./22. Endpoint Routing.md).

## Hooks

Xvelte provides a `hook` feature that allows you to insert custom logic into the request processing pipeline. Hooks are useful for performing common tasks before any route handler is executed, such as authentication, logging, or adding common data to the request object. The hook is executed immediately after the `RequestEvent` object is created upon receiving a request.

You can register a hook using the `app.hook()` method.

```ts
// src/app.ts
app.hook(async (event) => {
  // This runs for every request.
  console.log(`[${new Date().toISOString()}] ${event.method.toUpperCase()} ${event.url.pathname}`);

  const session = await getSessionFromCookie(event.cookie.get('sessionId'));
  if (!session && event.url.pathname.startsWith('/admin')) {
    // If there is no session when accessing an admin page, redirect to the login page.
    event.status = 302;
    event.setHeader('Location', '/login');
    return ''; // Immediately ends the response.
  }

  // Add user information to event.locals to be used in subsequent handlers.
  event.locals.user = session?.user;

  // You must return the event object to continue processing the next hook or route handler.
  return event;
});
```

The hook function receives the `RequestEvent` object as an argument.

-   Within the hook function, you can modify the `event` object and pass it to the next handler.
-   If the hook function returns a value other than the `event` object (e.g., `string`, `null`, `Buffer`), it immediately sends that value as a response to the client and terminates the request processing. This is useful for blocking requests or redirecting under certain conditions.
-   You can also execute multiple hooks sequentially using the `XvelteApp.sequence(...hooks)` function.