# 23. RequestEvent

`RequestEvent` 객체는 Xvelte의 모든 라우트 핸들러(페이지 및 엔드포인트)와 훅에 전달되는 객체입니다. 들어오는 HTTP 요청을 나타내며, 응답을 생성하고 제어하는 데 필요한 모든 속성과 메소드를 제공합니다.

## 주요 속성

| 속성             | 타입                               | 설명                                                                                             |
| ---------------- | ---------------------------------- | ------------------------------------------------------------------------------------------------ |
| `url`            | `URL`                              | 요청 URL에 대한 정보가 담긴 표준 `URL` 객체입니다. `url.pathname`, `url.searchParams` 등으로 사용합니다. |
| `params`         | `object`                           | 동적 라우팅에서 추출된 URL 파라미터를 담는 객체입니다. 예를 들어, `/users/:id` 경로에 `/users/123`으로 요청이 오면 `params`는 `{ id: '123' }`이 됩니다. |
| `requestHeaders` | `object`                           | 요청의 모든 HTTP 헤더를 담고 있는 객체입니다.                                                    |
| `locals`         | `object`                           | 요청의 생명주기 동안 데이터를 저장하고 공유하기 위한 객체입니다. 훅에서 `locals`에 저장한 데이터는 라우트 핸들러에서 접근할 수 있습니다. |
| `method`         | `string`                           | 요청의 HTTP 메소드입니다 (예: 'get', 'post'). 소문자로 제공됩니다.                               |
| `status`         | `number`                           | 응답으로 보낼 HTTP 상태 코드입니다. 기본값은 `200`이며, 핸들러 내에서 변경할 수 있습니다.         |
| `cookie`         | `object`                           | 쿠키를 쉽게 다룰 수 있는 유틸리티 객체입니다.                                                    |
| `request`        | `http.IncomingMessage`             | Node.js의 원시 요청(request) 객체입니다. 고급 기능이 필요할 때 사용합니다.                         |
| `response`       | `http.ServerResponse`              | Node.js의 원시 응답(response) 객체입니다. 고급 기능이 필요할 때 사용합니다.                         |

## 주요 메소드

### 요청 분석

-   **`async text(): Promise<string>`**
    요청 본문을 UTF-8 문자열로 읽어 반환합니다.

-   **`async json(): Promise<any>`**
    요청 본문을 JSON으로 파싱하여 JavaScript 객체로 반환합니다.

-   **`async blob(): Promise<Blob>`**
    요청 본문을 `Blob` 객체로 반환합니다.

-   **`async buffer(): Promise<Buffer>`**
    요청 본문을 Node.js의 `Buffer` 객체로 반환합니다.

-   **`async form(): Promise<{ fields: object, files: object }>`**
    `multipart/form-data` 형식의 요청 본문(폼 데이터)을 파싱합니다. 텍스트 필드와 업로드된 파일을 포함하는 객체를 반환합니다.

-   **`getClientAddress(): string`**
    클라이언트의 IP 주소를 반환합니다.

### 응답 제어

-   **`setHeader(key: string, value: string | number | string[]): void`**
    응답에 HTTP 헤더를 설정합니다.

-   **`redirect(location: string | URL, status?: number): void`**
    클라이언트를 다른 페이지로 리다이렉트합니다. 이 메소드를 호출하면 내부적으로 `status` 코드와 `Location` 헤더가 설정됩니다.
    -   `location`: 리다이렉트할 경로입니다.
    -   `status` (선택 사항): HTTP 상태 코드입니다. 기본값은 `302` (Found)입니다. 영구적인 이동을 위해서는 `301` (Moved Permanently)을 사용할 수 있습니다.

-   **`cookie.get(key: string): string | null`**
    요청에서 특정 키를 가진 쿠키 값을 읽습니다.

-   **`cookie.set(key: string, value: string, options: object): void`**
    응답에 쿠키를 설정합니다. `options` 객체를 통해 `path`, `maxAge`, `httpOnly` 등을 지정할 수 있습니다.

-   **`cookie.delete(key: string, options: object): void`**
    특정 쿠키를 삭제하도록 응답을 설정합니다.

## 사용 예제

### 폼 데이터 처리

```ts
// src/routes/api/profile/+server.ts
import type { RequestEvent } from '@hotsixman/xvelte';

export async function post(event: RequestEvent) {
  // 클라이언트 IP 로깅
  console.log('Client IP:', event.getClientAddress());

  // 폼 데이터 파싱
  const { fields, files } = await event.form();
  const username = fields.username as string;
  const avatar = files.avatar; // { filename, mimeType, buffer }

  // ... 파일 저장 및 데이터베이스 업데이트 로직 ...

  // 응답 상태 및 헤더 설정
  event.status = 201;
  event.setHeader('X-Custom-Header', 'Success');

  // 쿠키 설정
  event.cookie.set('username', username, { path: '/', httpOnly: true });

  // JSON 응답 반환
  event.setHeader('Content-Type', 'application/json');
  return JSON.stringify({ success: true, username });
}
```

### 리다이렉트

```ts
// src/routes/login/+server.ts
import type { RequestEvent } from '@hotsixman/xvelte';

export function post(event: RequestEvent) {
    // ...로그인 로직...

    // 로그인이 성공했다고 가정하고 메인 페이지로 리다이렉트
    event.redirect('/');

    // redirect() 호출 후에는 아무것도 반환하지 않아도 됩니다.
    return null;
}

// src/routes/admin/+server.ts
export function get(event: RequestEvent) {
    const user = event.locals.user; // 훅에서 주입된 사용자 정보

    // 관리자가 아니면 접근을 거부하고 로그인 페이지로 리다이렉트
    if (user?.role !== 'admin') {
        event.redirect('/login', 307); // 307: Temporary Redirect
        return null;
    }

    // ...관리자 페이지 데이터 반환...
}
```
